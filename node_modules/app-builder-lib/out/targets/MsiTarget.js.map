{"version":3,"sources":["../../src/targets/MsiTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, log, deepAssign } from \"builder-util\"\nimport { UUID } from \"builder-util-runtime\"\nimport { getBinFromGithub } from \"builder-util/out/binDownload\"\nimport { walk } from \"builder-util/out/fs\"\nimport { createHash } from \"crypto\"\nimport * as ejs from \"ejs\"\nimport { readFile, writeFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { MsiOptions } from \"../\"\nimport { Target } from \"../core\"\nimport { DesktopShortcutCreationPolicy, FinalCommonWindowsInstallerOptions, getEffectiveOptions } from \"../options/CommonWindowsInstallerConfiguration\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { VmManager } from \"../vm/vm\"\nimport { WineVmManager } from \"../vm/WineVm\"\nimport { WinPackager } from \"../winPackager\"\nimport { createStageDir, getWindowsInstallationDirName } from \"./targetUtil\"\n\nconst ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID = UUID.parse(\"d752fe43-5d44-44d5-9fc9-6dd1bf19d5cc\")\nconst ROOT_DIR_ID = \"APPLICATIONFOLDER\"\n\nconst ASSISTED_UI_FILE_NAME = \"WixUI_Assisted.wxs\"\n\nconst projectTemplate = new Lazy<(data: any) => string>(async () => {\n  const template = (await readFile(path.join(getTemplatePath(\"msi\"), \"template.xml\"), \"utf8\"))\n    .replace(/{{/g, \"<%\")\n    .replace(/}}/g, \"%>\")\n    .replace(/\\${([^}]+)}/g, \"<%=$1%>\")\n  return ejs.compile(template)\n})\n\n// WiX doesn't support Mono, so, dontnet462 is required to be installed for wine (preinstalled in our bundled wine)\nexport default class MsiTarget extends Target {\n  private readonly vm = process.platform === \"win32\" ? new VmManager() : new WineVmManager()\n\n  readonly options: MsiOptions = deepAssign(this.packager.platformSpecificBuildOptions, this.packager.config.msi)\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"msi\")\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    const packager = this.packager\n    const artifactName = packager.expandArtifactNamePattern(this.options, \"msi\", arch)\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"MSI\", artifactPath, arch)\n\n    const stageDir = await createStageDir(this, packager, arch)\n    const vm = this.vm\n\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n\n    if (commonOptions.isAssisted) {\n      // F*** *** ***  ***  ***  ***  ***  ***  ***  ***  ***  ***  *** WiX  ***  ***  ***  ***  ***  ***  ***  ***  ***\n      // cannot understand how to set MSIINSTALLPERUSER on radio box change. In any case installed per user.\n      log.warn(`MSI DOESN'T SUPPORT assisted installer. Please use NSIS instead.`)\n    }\n\n    const projectFile = stageDir.getTempFile(\"project.wxs\")\n    const objectFiles = [\"project.wixobj\"]\n    const uiFile = commonOptions.isAssisted ?  stageDir.getTempFile(ASSISTED_UI_FILE_NAME) : null\n    await writeFile(projectFile, await this.writeManifest(appOutDir, arch, commonOptions))\n    if (uiFile !== null) {\n      await writeFile(uiFile, await readFile(path.join(getTemplatePath(\"msi\"), ASSISTED_UI_FILE_NAME), \"utf8\"))\n      objectFiles.push(ASSISTED_UI_FILE_NAME.replace(\".wxs\", \".wixobj\"))\n    }\n\n    // noinspection SpellCheckingInspection\n    const vendorPath = await getBinFromGithub(\"wix\", \"4.0.0.5512.2\", \"/X5poahdCc3199Vt6AP7gluTlT1nxi9cbbHhZhCMEu+ngyP1LiBMn+oZX7QAZVaKeBMc2SjVp7fJqNLqsUnPNQ==\")\n\n    // noinspection SpellCheckingInspection\n    const candleArgs = [\n      \"-arch\", arch === Arch.ia32 ? \"x86\" : (arch === Arch.armv7l ? \"arm\" : \"x64\"),\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n    ].concat(this.getCommonWixArgs())\n    candleArgs.push(\"project.wxs\")\n    if (uiFile !== null) {\n      candleArgs.push(ASSISTED_UI_FILE_NAME)\n    }\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"candle.exe\")), candleArgs, {\n      cwd: stageDir.dir,\n    })\n\n    await this.light(objectFiles, vm, artifactPath, appOutDir, vendorPath, stageDir.dir)\n\n    await stageDir.cleanup()\n\n    await packager.sign(artifactPath)\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      packager,\n      arch,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"msi\"),\n      target: this,\n      isWriteUpdateInfo: false,\n    })\n  }\n\n  private async light(objectFiles: Array<string>, vm: VmManager, artifactPath: string, appOutDir: string, vendorPath: string, tempDir: string) {\n    // noinspection SpellCheckingInspection\n    const lightArgs = [\n      \"-out\", vm.toVmFile(artifactPath),\n      \"-v\",\n      // https://github.com/wixtoolset/issues/issues/5169\n      \"-spdb\",\n      // https://sourceforge.net/p/wix/bugs/2405/\n      // error LGHT1076 : ICE61: This product should remove only older versions of itself. The Maximum version is not less than the current product. (1.1.0.42 1.1.0.42)\n      \"-sw1076\",\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n      // \"-dcl:high\",\n    ].concat(this.getCommonWixArgs())\n\n    // http://windows-installer-xml-wix-toolset.687559.n2.nabble.com/Build-3-5-2229-0-give-me-the-following-error-error-LGHT0216-An-unexpected-Win32-exception-with-errorn-td5707443.html\n    if (process.platform !== \"win32\") {\n      // noinspection SpellCheckingInspection\n      lightArgs.push(\"-sval\")\n    }\n\n    if (this.options.oneClick === false) {\n      lightArgs.push(\"-ext\", \"WixUIExtension\")\n    }\n\n    // objectFiles - only filenames, we set current directory to our temp stage dir\n    lightArgs.push(...objectFiles)\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"light.exe\")), lightArgs, {\n      cwd: tempDir,\n    })\n  }\n\n  private getCommonWixArgs() {\n    const args: Array<string> = [\"-pedantic\"]\n    if (this.options.warningsAsErrors !== false) {\n      args.push(\"-wx\")\n    }\n    return args\n  }\n\n  private async writeManifest(appOutDir: string, arch: Arch, commonOptions: FinalCommonWindowsInstallerOptions) {\n    const appInfo = this.packager.appInfo\n    const {files, dirs} = await this.computeFileDeclaration(appOutDir)\n\n    const companyName = appInfo.companyName\n    if (!companyName) {\n      log.warn(`Manufacturer is not set for MSI â€” please set \"author\" in the package.json`)\n    }\n\n    const compression = this.packager.compression\n    const options = this.options\n    const iconPath = await this.packager.getIconPath()\n    return (await projectTemplate.value)({\n      ...commonOptions,\n      isCreateDesktopShortcut: commonOptions.isCreateDesktopShortcut !== DesktopShortcutCreationPolicy.NEVER,\n      isRunAfterFinish: options.runAfterFinish !== false,\n      iconPath: iconPath == null ? null : this.vm.toVmFile(iconPath),\n      compressionLevel: compression === \"store\" ? \"none\" : \"high\",\n      version: appInfo.versionInWeirdWindowsForm,\n      productName: appInfo.productName,\n      upgradeCode: (options.upgradeCode || UUID.v5(appInfo.id, ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID)).toUpperCase(),\n      manufacturer: companyName || appInfo.productName,\n      appDescription: appInfo.description,\n      // https://stackoverflow.com/questions/1929038/compilation-error-ice80-the-64bitcomponent-uses-32bitdirectory\n      programFilesId: arch === Arch.x64 ? \"ProgramFiles64Folder\" : \"ProgramFilesFolder\",\n      // wix in the name because special wix format can be used in the name\n      installationDirectoryWixName: getWindowsInstallationDirName(appInfo, commonOptions.isPerMachine === true),\n      dirs,\n      files,\n    })\n  }\n\n  private async computeFileDeclaration(appOutDir: string) {\n    const appInfo = this.packager.appInfo\n    let isRootDirAddedToRemoveTable = false\n    const dirNames = new Set<string>()\n    const dirs: Array<string> = []\n    const fileSpace = \" \".repeat(6)\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n    const files = await BluebirdPromise.map(walk(appOutDir), file => {\n      const packagePath = file.substring(appOutDir.length + 1)\n\n      const lastSlash = packagePath.lastIndexOf(path.sep)\n      const fileName = lastSlash > 0 ? packagePath.substring(lastSlash + 1) : packagePath\n      let directoryId: string | null = null\n      let dirName = \"\"\n      // Wix Directory.FileSource doesn't work - https://stackoverflow.com/questions/21519388/wix-filesource-confusion\n      if (lastSlash > 0) {\n        // This Name attribute may also define multiple directories using the inline directory syntax.\n        // For example, \"ProgramFilesFolder:\\My Company\\My Product\\bin\" would create a reference to a Directory element with Id=\"ProgramFilesFolder\" then create directories named \"My Company\" then \"My Product\" then \"bin\" nested beneath each other.\n        // This syntax is a shortcut to defining each directory in an individual Directory element.\n        dirName = packagePath.substring(0, lastSlash)\n        // https://github.com/electron-userland/electron-builder/issues/3027\n        directoryId = \"d\" + createHash(\"md5\").update(dirName).digest(\"base64\").replace(/\\//g, \"_\").replace(/\\+/g, \".\").replace(/=+$/, \"\")\n        if (!dirNames.has(dirName)) {\n          dirNames.add(dirName)\n          dirs.push(`<Directory Id=\"${directoryId}\" Name=\"${ROOT_DIR_ID}:\\\\${dirName.replace(/\\//g, \"\\\\\")}\\\\\"/>`)\n        }\n      }\n      else if (!isRootDirAddedToRemoveTable) {\n        isRootDirAddedToRemoveTable = true\n      }\n\n      // since RegistryValue can be part of Component, *** *** *** *** *** *** *** *** *** wix cannot auto generate guid\n      // https://stackoverflow.com/questions/1405100/change-my-component-guid-in-wix\n      let result = `<Component${directoryId === null ? \"\" : ` Directory=\"${directoryId}\"`}>`\n      result += `\\n${fileSpace}  <File Name=\"${fileName}\" Source=\"$(var.appDir)${path.sep}${packagePath}\" ReadOnly=\"yes\" KeyPath=\"yes\"`\n      const isMainExecutable = packagePath === `${appInfo.productFilename}.exe`\n      if (isMainExecutable) {\n        result += ' Id=\"mainExecutable\"'\n      }\n      else if (directoryId === null) {\n        result += ` Id=\"${path.basename(packagePath)}_f\"`\n      }\n\n      const isCreateDesktopShortcut = commonOptions.isCreateDesktopShortcut !== DesktopShortcutCreationPolicy.NEVER\n      if (isMainExecutable && (isCreateDesktopShortcut || commonOptions.isCreateStartMenuShortcut)) {\n        result += `>\\n`\n        const shortcutName = commonOptions.shortcutName\n        if (isCreateDesktopShortcut) {\n          result += `${fileSpace}  <Shortcut Id=\"desktopShortcut\" Directory=\"DesktopFolder\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\"/>\\n`\n        }\n\n        const hasMenuCategory = commonOptions.menuCategory != null\n        const startMenuShortcutDirectoryId = hasMenuCategory ? \"AppProgramMenuDir\" : \"ProgramMenuFolder\"\n        if (commonOptions.isCreateStartMenuShortcut) {\n          if (hasMenuCategory) {\n            dirs.push(`<Directory Id=\"${startMenuShortcutDirectoryId}\" Name=\"ProgramMenuFolder:\\\\${commonOptions.menuCategory}\\\\\"/>`)\n          }\n          result += `${fileSpace}  <Shortcut Id=\"startMenuShortcut\" Directory=\"${startMenuShortcutDirectoryId}\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\">\\n`\n          result += `${fileSpace}    <ShortcutProperty Key=\"System.AppUserModel.ID\" Value=\"${this.packager.appInfo.id}\"/>\\n`\n          result += `${fileSpace}  </Shortcut>\\n`\n        }\n        result += `${fileSpace}</File>`\n\n        if (hasMenuCategory) {\n          result += `<RemoveFolder Id=\"${startMenuShortcutDirectoryId}\" On=\"uninstall\"/>\\n`\n        }\n      }\n      else {\n        result += `/>`\n      }\n\n      return `${result}\\n${fileSpace}</Component>`\n    })\n\n    return {dirs: listToString(dirs, 2), files: listToString(files, 3)}\n  }\n}\n\nfunction listToString(list: Array<string>, indentLevel:  number) {\n  const space = \" \".repeat(indentLevel * 2)\n  return list.join(`\\n${space}`)\n}"],"sourceRoot":""}
